<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Geo-Targeting Tool Pro</title>
    <meta name="description" content="X(Twitter)„ÅÆgeocodeÊ§úÁ¥¢„ÇíË¶ñË¶öÁöÑ„Å´‰ΩúÊàê„Åô„Çã„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„ÉÑ„Éº„É´">

    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        :root {
            --primary-blue: #1d9bf0;
            --danger-red: #e0245e;
            --bg-dark: #15202b;
            --sidebar-width: 380px;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body { font-family: var(--font-main); margin: 0; display: flex; height: 100vh; background: var(--bg-dark); color: white; overflow: hidden; }

        /* „É¨„Ç§„Ç¢„Ç¶„Éà */
        #map { flex-grow: 1; height: 100%; position: relative; }
        #sidebar {
            width: var(--sidebar-width); background: #000; border-left: 1px solid #333;
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; z-index: 10; overflow-y: auto;
        }

        /* „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà */
        .header { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .lang-selector { margin-bottom: 15px; display: flex; gap: 5px; align-items: center; }
        .btn-lang { padding: 4px 8px; font-size: 11px; background: #222; color: #ccc; border: 1px solid #444; border-radius: 4px; cursor: pointer; }
        .btn-lang.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }

        .search-box input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #111; color: white; margin-bottom: 15px; }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; text-align: center; text-decoration: none; }
        .btn-plus { background: var(--primary-blue); color: white; }
        .btn-minus { background: var(--danger-red); color: white; }
        .btn-util { background: #333; color: white; font-size: 12px; }

        .circle-item { background: #1a1a1a; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #333; }
        .type-include { border-left-color: var(--primary-blue); }
        .type-exclude { border-left-color: var(--danger-red); }

        .query-container { background: #111; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-top: auto; }
        #query-text { font-family: 'Courier New', monospace; font-size: 12px; color: var(--primary-blue); word-break: break-all; min-height: 50px; display: block; }
        .char-counter { font-size: 11px; text-align: right; color: #888; margin-top: 5px; }
        .limit-over { color: var(--danger-red); font-weight: bold; }

        #debug-panel {
            position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.8);
            padding: 10px; border-radius: 4px; font-size: 10px; color: #0f0; pointer-events: none; display: none;
        }

        /* [AD/WIDGET SLOT] */
        .ad-container { margin-top: 15px; min-height: 50px; background: #0a0a0a; border: 1px dashed #333; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #444; }

        @media (max-width: 800px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 50%; border-left: none; border-top: 1px solid #333; }
        }
    </style>
</head>
<body>

<div id="map">
    <div id="debug-panel"></div>
</div>

<div id="sidebar">
    <div class="header">
        <h2 style="margin:0; font-size: 1.2rem;">X Geo Pro <span id="debug-trigger" style="cursor:help">üõ†Ô∏è</span></h2>
    </div>

    <div class="lang-selector">
        <label style="font-size:11px; color:#666">Map Labels:</label>
        <button class="btn-lang active" data-lang="ja">Êó•Êú¨Ë™û</button>
        <button class="btn-lang" data-lang="en">English</button>
        <button class="btn-lang" data-lang="zh">‰∏≠Êñá</button>
    </div>

    <div class="search-box">
        <input type="text" id="addr-search" placeholder="Âú∞Âêç„ÇíÂÖ•Âäõ„Åó„Å¶Enter (‰æã: Jerusalem)">
    </div>

    <div class="controls">
        <button class="btn btn-plus" id="btn-add-inc">+ ËøΩÂä† (0/4)</button>
        <button class="btn btn-minus" id="btn-add-exc">- Èô§Â§ñ (0/4)</button>
    </div>

    <div id="circle-list" style="flex-grow: 1; overflow-y: auto;"></div>

    <div id="edit-utils" style="display:flex; gap:5px; margin-bottom:10px;">
        <button class="btn btn-util" style="flex:1" id="undo-btn">Undo</button>
        <button class="btn btn-util" style="flex:1" id="redo-btn">Redo</button>
    </div>

    <div class="query-container">
        <strong style="font-size: 11px; color:#888;">TwitterÊ§úÁ¥¢„Ç≥„Éû„É≥„Éâ:</strong>
        <span id="query-text">geocode:31.5,34.7,50km</span>
        <div class="char-counter" id="char-count">0 / 500 characters</div>
        <button class="btn btn-plus" style="width:100%; margin-top:10px;" id="copy-btn">„Ç≥„Éû„É≥„Éâ„Çí„Ç≥„Éî„Éº</button>
        <button class="btn btn-util" style="width:100%; margin-top:5px;" id="export-btn">JSON„Ç®„ÇØ„Çπ„Éù„Éº„Éà</button>
    </div>

    <div class="ad-container">
        ADVERTISEMENT
    </div>
</div>

<script>
/**
 * X-Geo-Targeting Tool (Professional Grade)
 * * // [PERFORMANCE NOTE]
 * // 1. Âú∞Âõ≥„ÅÆÊõ¥Êñ∞(renderMap)„ÅØ requestAnimationFrame „Åæ„Åü„ÅØ debounce „ÇíÊ§úË®é„Åó„Åü„Åå„ÄÅ
 * //    ÁèæÁä∂„ÅÆ¬±4Âà∂ÈôêÂÜÖ„Åß„ÅÇ„Çå„Å∞ Turf.js „ÅÆË®àÁÆó„Ç≥„Çπ„Éà„Åå‰Ωé„ÅÑ„Åü„ÇÅ„ÄÅÁä∂ÊÖãÂ§âÊõ¥„ÅÆÈÉΩÂ∫¶Âç≥ÊôÇÊõ¥Êñ∞(setData)„Åó„Å¶„ÅÑ„Çã„ÄÇ
 * // 2. Â§ßÈáè„ÅÆÂÜÜ„ÇíÊâ±„ÅÜÂ†¥Âêà„ÅØ„ÄÅÂêÑ„Çµ„Éº„ÇØ„É´„ÇíÂÄãÂà•„ÅÆFeature„Å®„Åó„Å¶ÁÆ°ÁêÜ„Åó„ÄÅID„Éô„Éº„Çπ„ÅßÈÉ®ÂàÜÊõ¥Êñ∞„Åô„Çã„Åì„Å®„ÇíÊé®Â•®„ÄÇ
 */

const CONFIG = {
    DEFAULT_CENTER: [34.7818, 31.5], // Israel
    MAX_CIRCLES: 4,
    MAP_STYLE: 'https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json',
    PRECISION: 5
};

class AppCore {
    constructor() {
        this.state = {
            circles: [],
            mode: null,
            lang: 'ja',
            debug: false
        };
        this.history = [];
        this.redoStack = [];
        this.map = null;
        this.isDirty = false;

        this.init();
    }

    init() {
        // MapLibre„ÅÆÂàùÊúüÂåñ
        this.map = new maplibregl.Map({
            container: 'map',
            style: CONFIG.MAP_STYLE,
            center: CONFIG.DEFAULT_CENTER,
            zoom: 6,
            attributionControl: false
        });

        this.map.on('load', () => {
            this.setupLayers();
            this.applyLanguage('ja');
            this.loadLocalStorage();
            this.bindEvents();
            this.logDebug("Map Engine Loaded: MapLibre GL JS");
        });
    }

    setupLayers() {
        this.map.addSource('circles', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
        
        // ËøΩÂä†(Include)„É¨„Ç§„É§„Éº
        this.map.addLayer({
            id: 'circle-fill',
            type: 'fill',
            source: 'circles',
            paint: {
                'fill-color': ['match', ['get', 'type'], 'include', '#1d9bf0', '#e0245e'],
                'fill-opacity': 0.3,
                'fill-outline-color': ['match', ['get', 'type'], 'include', '#1d9bf0', '#e0245e']
            }
        });
    }

    applyLanguage(lang) {
        this.state.lang = lang;
        const style = this.map.getStyle();
        
        // ÂÖ®„ÉÜ„Ç≠„Çπ„Éà„É¨„Ç§„É§„Éº„ÅÆË®ÄË™û„Éï„Ç£„Éº„É´„Éâ„ÇíÂãïÁöÑ„Å´Êõ∏„ÅçÊèõ„Åà
        style.layers.forEach(layer => {
            if (layer.layout && layer.layout['text-field']) {
                this.map.setLayoutProperty(layer.id, 'text-field', [
                    'coalesce',
                    ['get', `name:${lang}`],
                    ['get', 'name:en'],
                    ['get', 'name']
                ]);
            }
        });
        
        document.querySelectorAll('.btn-lang').forEach(b => {
            b.classList.toggle('active', b.dataset.lang === lang);
        });
        this.logDebug(`Language switched to: ${lang}`);
    }

    bindEvents() {
        // Âú∞Âõ≥„ÇØ„É™„ÉÉ„ÇØ
        this.map.on('click', (e) => {
            if (!this.state.mode) return;
            this.addCircle(e.lngLat.lat, e.lngLat.lng, 50, this.state.mode);
            this.setMode(null);
        });

        // „É¢„Éº„ÉâÂ§âÊõ¥
        document.getElementById('btn-add-inc').onclick = () => this.setMode('include');
        document.getElementById('btn-add-exc').onclick = () => this.setMode('exclude');

        // Ë®ÄË™ûÂàáÊõø
        document.querySelectorAll('.btn-lang').forEach(btn => {
            btn.onclick = () => this.applyLanguage(btn.dataset.lang);
        });

        // ‰ΩèÊâÄÊ§úÁ¥¢
        document.getElementById('addr-search').onkeydown = async (e) => {
            if (e.key === 'Enter') this.searchAddress(e.target.value);
        };

        // „Ç≥„Éî„Éº & Â±•Ê≠¥
        document.getElementById('copy-btn').onclick = () => this.copyToClipboard();
        document.getElementById('undo-btn').onclick = () => this.undo();
        document.getElementById('redo-btn').onclick = () => this.redo();
        document.getElementById('export-btn').onclick = () => this.exportJSON();

        // Èõ¢ËÑ±Ë≠¶Âëä
        window.onbeforeunload = (e) => {
            if (this.isDirty) return "Â§âÊõ¥„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ";
        };

        // „Éá„Éê„ÉÉ„Ç∞„Éà„Ç∞„É´
        document.getElementById('debug-trigger').onclick = () => {
            this.state.debug = !this.state.debug;
            document.getElementById('debug-panel').style.display = this.state.debug ? 'block' : 'none';
        };
    }

    setMode(mode) {
        this.state.mode = mode;
        this.map.getCanvas().style.cursor = mode ? 'crosshair' : '';
    }

    async searchAddress(query) {
        try {
            const res = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=1`);
            const data = await res.json();
            if (data.features.length > 0) {
                const [lng, lat] = data.features[0].geometry.coordinates;
                this.map.flyTo({ center: [lng, lat], zoom: 10 });
            }
        } catch (err) {
            console.error("Geocoding Error:", err);
        }
    }

    addCircle(lat, lng, radius, type) {
        if (this.state.circles.filter(c => c.type === type).length >= CONFIG.MAX_CIRCLES) {
            alert(`ÊúÄÂ§ß${CONFIG.MAX_CIRCLES}ÂÄã„Åæ„Åß„Åß„Åô„ÄÇ`);
            return;
        }
        this.pushHistory();
        this.state.circles.push({ id: Date.now().toString(), lat, lng, radius, type });
        this.update();
    }

    updateCircle(id, radius) {
        this.state.circles = this.state.circles.map(c => c.id === id ? { ...c, radius } : c);
        this.update();
    }

    removeCircle(id) {
        this.pushHistory();
        this.state.circles = this.state.circles.filter(c => c.id !== id);
        this.update();
    }

    update() {
        this.isDirty = true;
        this.renderMap();
        this.renderUI();
        this.saveLocalStorage();
    }

    renderMap() {
        const features = this.state.circles.map(c => {
            const circle = turf.circle([c.lng, c.lat], c.radius, { units: 'kilometers' });
            circle.properties = { type: c.type, id: c.id };
            return circle;
        });
        this.map.getSource('circles').setData({ type: 'FeatureCollection', features });
    }

    renderUI() {
        const list = document.getElementById('circle-list');
        list.innerHTML = '';
        
        this.state.circles.forEach(c => {
            const el = document.createElement('div');
            el.className = `circle-item type-${c.type}`;
            el.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-size:11px; font-weight:bold;">${c.type === 'include' ? 'ËøΩÂä†„Ç®„É™„Ç¢' : 'Èô§Â§ñ„Ç®„É™„Ç¢'}</span>
                    <span style="font-size:10px; color:#666;">${c.lat.toFixed(3)}, ${c.lng.toFixed(3)}</span>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="range" min="1" max="500" value="${c.radius}" style="flex:1" 
                           oninput="app.updateCircle('${c.id}', parseInt(this.value))">
                    <span style="font-size:11px; width:40px;">${c.radius}km</span>
                    <button class="btn-util" onclick="app.removeCircle('${c.id}')" style="padding:2px 6px;">√ó</button>
                </div>
            `;
            list.appendChild(el);
        });

        // „ÇØ„Ç®„É™ÁîüÊàê & ÊñáÂ≠óÊï∞„Ç´„Ç¶„É≥„Éà
        const query = this.state.circles.map(c => {
            const p = c.type === 'include' ? '' : '-';
            return `${p}geocode:${c.lat.toFixed(CONFIG.PRECISION)},${c.lng.toFixed(CONFIG.PRECISION)},${c.radius}km`;
        }).join(' ');

        const queryDisplay = document.getElementById('query-text');
        queryDisplay.innerText = query || 'Âú∞Âõ≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁØÑÂõ≤„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        
        const count = query.length;
        const counter = document.getElementById('char-count');
        counter.innerText = `${count} / 500 characters`;
        counter.className = count > 500 ? 'char-counter limit-over' : 'char-counter';

        // ÂÄãÊï∞Ë°®Á§∫
        document.getElementById('btn-add-inc').innerText = `+ ËøΩÂä† (${this.state.circles.filter(c => c.type === 'include').length}/4)`;
        document.getElementById('btn-add-exc').innerText = `- Èô§Â§ñ (${this.state.circles.filter(c => c.type === 'exclude').length}/4)`;
        
        this.logDebug(`UI Refreshed. Circles: ${this.state.circles.length}`);
    }

    pushHistory() {
        this.history.push(JSON.stringify(this.state.circles));
        if (this.history.length > 20) this.history.shift();
        this.redoStack = [];
    }

    undo() {
        if (!this.history.length) return;
        this.redoStack.push(JSON.stringify(this.state.circles));
        this.state.circles = JSON.parse(this.history.pop());
        this.update();
    }

    redo() {
        if (!this.redoStack.length) return;
        this.history.push(JSON.stringify(this.state.circles));
        this.state.circles = JSON.parse(this.redoStack.pop());
        this.update();
    }

    copyToClipboard() {
        const text = document.getElementById('query-text').innerText;
        if (!text.includes('geocode')) return;
        navigator.clipboard.writeText(text);
        alert("„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü");
    }

    saveLocalStorage() {
        localStorage.setItem('x_geo_target_state', JSON.stringify(this.state.circles));
    }

    loadLocalStorage() {
        const saved = localStorage.getItem('x_geo_target_state');
        if (saved) {
            this.state.circles = JSON.parse(saved);
            this.update();
        }
    }

    exportJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.state.circles));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "x_geo_config.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    logDebug(msg) {
        const panel = document.getElementById('debug-panel');
        const time = new Date().toLocaleTimeString();
        panel.innerHTML = `[${time}] ${msg}<br>` + panel.innerHTML;
        console.log(`[DEBUG] ${msg}`);
    }
}

// „Ç∞„É≠„Éº„Éê„É´Â±ïÈñã
const app = new AppCore();
</script>

</body>
</html>
