<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X(Twitter) Geocode Generator</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #controls { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 1000; }
        #map { flex-grow: 1; }
        .result-area { margin-top: 10px; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        #query-display { font-family: monospace; word-break: break-all; color: #1d9bf0; font-weight: bold; min-height: 1.2em; display: block; }
        .btn { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; margin-right: 5px; margin-bottom: 5px; }
        .btn-add { background: #1d9bf0; color: white; }
        .btn-exclude { background: #e0245e; color: white; }
        .btn-copy { background: #4b5563; color: white; }
        .instruction { font-size: 0.85rem; color: #666; margin-bottom: 8px; }
        .lang-selector { margin-bottom: 10px; float: right; }
        select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div id="controls">
    <div class="lang-selector">
        <select id="language-select" onchange="changeLanguage()">
            <option value="ja">日本語</option>
            <option value="en">English</option>
            <option value="zh">中文</option>
        </select>
    </div>
    <h3 id="ui-title">X Geocode Generator</h3>
    <p class="instruction" id="ui-instruction">1. ボタンを押してから地図をクリックして円を設置 / 2. 中心をドラッグして移動 / 3. ダブルクリックで削除</p>
    
    <button class="btn btn-add" id="ui-btn-add" onclick="setMode('include')">+ 検索範囲を追加</button>
    <button class="btn btn-exclude" id="ui-btn-exclude" onclick="setMode('exclude')">- 除外範囲を追加</button>
    <button class="btn btn-copy" id="ui-btn-copy" onclick="copyToClipboard()">コマンドをコピー</button>
    
    <div class="result-area">
        <strong id="ui-result-label">検索コマンド:</strong><br>
        <span id="query-display"></span>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 多言語辞書
    const i18n = {
        ja: {
            title: "X Geocode Generator",
            instruction: "1. ボタンを押して地図をクリック / 2. 中心ドラッグで移動 / 3. ダブルクリックで削除",
            btnAdd: "+ 検索範囲を追加",
            btnExclude: "- 除外範囲を追加",
            btnCopy: "コマンドをコピー",
            resultLabel: "検索コマンド:",
            copyMsg: "コピーしました！",
            tileUrl: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" // 標準OSM
        },
        en: {
            title: "X Geocode Generator",
            instruction: "1. Click button then map to add / 2. Drag center to move / 3. Double-click to delete",
            btnAdd: "+ Add Search Area",
            btnExclude: "- Add Exclude Area",
            btnCopy: "Copy Command",
            resultLabel: "Search Command:",
            copyMsg: "Copied!",
            tileUrl: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
        },
        zh: {
            title: "X 地理编码生成器",
            instruction: "1. 点击按钮后点击地图 / 2. 拖动中心移动 / 3. 双击删除",
            btnAdd: "+ 添加搜索范围",
            btnExclude: "- 添加排除范围",
            btnCopy: "复制命令",
            resultLabel: "搜索命令:",
            copyMsg: "已复制！",
            tileUrl: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
        }
    };

    let currentLang = 'ja';
    let map = L.map('map').setView([35.6812, 139.7671], 5); // 初期位置: 東京
    let tileLayer = L.tileLayer(i18n[currentLang].tileUrl, {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let includeCircles = [];
    let excludeCircles = [];
    let currentMode = null;

    function changeLanguage() {
        currentLang = document.getElementById('language-select').value;
        
        // UIテキストの更新
        document.getElementById('ui-title').innerText = i18n[currentLang].title;
        document.getElementById('ui-instruction').innerText = i18n[currentLang].instruction;
        document.getElementById('ui-btn-add').innerText = i18n[currentLang].btnAdd;
        document.getElementById('ui-btn-exclude').innerText = i18n[currentLang].btnExclude;
        document.getElementById('ui-btn-copy').innerText = i18n[currentLang].btnCopy;
        document.getElementById('ui-result-label').innerText = i18n[currentLang].resultLabel;

        // 地図の再描画（言語切り替え対応タイルがある場合）
        map.removeLayer(tileLayer);
        // 注: OSM標準タイルは言語固定ですが、多言語タイルサーバーを指定すればここで切り替わります
        tileLayer = L.tileLayer(i18n[currentLang].tileUrl).addTo(map);
    }

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('map').style.cursor = 'crosshair';
    }

    map.on('click', function(e) {
        if (!currentMode) return;

        const color = currentMode === 'include' ? '#1d9bf0' : '#e0245e';
        const circle = L.circle(e.latlng, {
            color: color,
            fillColor: color,
            fillOpacity: 0.3,
            radius: 50000, 
            interactive: true
        }).addTo(map);

        // 円のドラッグ移動機能
        let isDragging = false;
        circle.on('mousedown', function(event) {
            isDragging = true;
            map.dragging.disable();
            L.DomEvent.stopPropagation(event);
        });

        map.on('mousemove', function(event) {
            if (isDragging) {
                circle.setLatLng(event.latlng);
                updateQuery();
            }
        });

        map.on('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                map.dragging.enable();
            }
        });

        // ダブルクリックで削除
        circle.on('dblclick', function(event) {
            map.removeLayer(circle);
            includeCircles = includeCircles.filter(c => c !== circle);
            excludeCircles = excludeCircles.filter(c => c !== circle);
            updateQuery();
            L.DomEvent.stopPropagation(event);
        });

        if (currentMode === 'include') includeCircles.push(circle);
        else excludeCircles.push(circle);

        updateQuery();
        currentMode = null;
        document.getElementById('map').style.cursor = '';
    });

    function updateQuery() {
        let queryParts = [];
        includeCircles.forEach(c => {
            const lat = c.getLatLng().lat.toFixed(4);
            const lng = c.getLatLng().lng.toFixed(4);
            const rad = Math.round(c.getRadius() / 1000);
            queryParts.push(`geocode:${lat},${lng},${rad}km`);
        });

        excludeCircles.forEach(c => {
            const lat = c.getLatLng().lat.toFixed(4);
            const lng = c.getLatLng().lng.toFixed(4);
            const rad = Math.round(c.getRadius() / 1000);
            queryParts.push(`-geocode:${lat},${lng},${rad}km`);
        });

        document.getElementById('query-display').innerText = queryParts.join(' ');
    }

    function copyToClipboard() {
        const text = document.getElementById('query-display').innerText;
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            alert(i18n[currentLang].copyMsg);
        });
    }

    // 初期化
    updateQuery();
</script>

</body>
</html>
