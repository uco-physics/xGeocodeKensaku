<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X Geo-Targeter Pro (Language Fixed)</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <style>
        :root {
            --primary-blue: #1d9bf0;
            --danger-red: #e0245e;
            --bg-dark: #15202b;
            --sidebar-width: 380px;
        }
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg-dark); color: white; }
        #map { flex-grow: 1; height: 100%; position: relative; }
        #sidebar {
            width: var(--sidebar-width); background: #000; border-left: 1px solid #333;
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; overflow-y: auto;
        }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; }
        .btn-plus { background: var(--primary-blue); color: white; }
        .btn-minus { background: var(--danger-red); color: white; }
        .btn-util { background: #333; color: white; }
        
        /* 言語セレクターのスタイル */
        .lang-selector { margin-bottom: 15px; display: flex; gap: 5px; align-items: center; }
        .lang-selector label { font-size: 12px; color: #888; margin-right: 5px; }
        .btn-lang { padding: 4px 8px; font-size: 11px; background: #222; color: #ccc; border: 1px solid #444; border-radius: 4px; cursor: pointer; }
        .btn-lang.active { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }

        .search-box input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #111; color: white; box-sizing: border-box; margin-bottom: 20px; }
        .query-container { background: #111; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-top: auto; }
        #query-text { font-family: monospace; font-size: 12px; color: var(--primary-blue); word-break: break-all; min-height: 40px; display: block; }
        .circle-item { background: #1a1a1a; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .type-include { border-left-color: var(--primary-blue); }
        .type-exclude { border-left-color: var(--danger-red); }
    </style>
</head>
<body>

<div id="map"></div>

<div id="sidebar">
    <h2 style="margin:0 0 15px 0; font-size: 1.1rem;">X Geo-Targeter Pro</h2>

    <div class="lang-selector">
        <label>Map Language:</label>
        <button class="btn-lang active" onclick="app.setMapLanguage('ja')">日本語</button>
        <button class="btn-lang" onclick="app.setMapLanguage('en')">English</button>
        <button class="btn-lang" onclick="app.setMapLanguage('zh')">中国語</button>
    </div>

    <div class="search-box">
        <input type="text" id="addr-search" placeholder="地名検索 (Enterでジャンプ)">
    </div>

    <div class="controls">
        <button class="btn btn-plus" id="btn-add-inc">+ 追加 (0/4)</button>
        <button class="btn btn-minus" id="btn-add-exc">- 除外 (0/4)</button>
    </div>

    <div id="circle-list" style="flex-grow: 1;"></div>

    <div class="query-container">
        <span id="query-text">geocode:...</span>
        <button class="btn btn-plus" style="width:100%; margin-top:10px;" onclick="app.copyQuery()">コピー</button>
        <button class="btn btn-util" style="width:100%; margin-top:5px; font-size: 11px;" onclick="app.undo()">Undo</button>
    </div>
</div>

<script>
class GeoTargeter {
    constructor() {
        this.state = { circles: [], mode: null, currentLang: 'ja' };
        this.history = [];
        this.map = null;
        this.init();
    }

    init() {
        // デフォルトで日本語を優先するベクトルタイル
        this.map = new maplibregl.Map({
            container: 'map',
            style: 'https://tile.openstreetmap.jp/styles/osm-bright-ja/style.json',
            center: [34.7818, 31.5],
            zoom: 6
        });

        this.map.on('load', () => {
            this.setupMapLayers();
            this.setMapLanguage('ja'); // 初期言語を強制適用
            this.bindEvents();
            this.load();
        });
    }

    /**
     * 【重要】地図上の全ラベルの表示言語を強制的に切り替える
     * @param {string} langCode - 'ja', 'en', 'zh' など
     */
    setMapLanguage(langCode) {
        this.state.currentLang = langCode;
        
        // スタイル内のレイヤーを走査
        const style = this.map.getStyle();
        style.layers.forEach(layer => {
            // テキスト表示フィールドを持つレイヤーを探す
            if (layer.layout && layer.layout['text-field']) {
                // 各言語のフィールド名マッピング（タイルセットの仕様に合わせる）
                const langField = langCode === 'ja' ? '{name:ja}' : 
                                 langCode === 'en' ? '{name:en}' : '{name:zh}';
                
                // 特定の国の言語ではなく、指定した言語のフィールドを優先的に表示するように変更
                this.map.setLayoutProperty(layer.id, 'text-field', [
                    'coalesce', 
                    ['get', 'name:' + langCode], 
                    ['get', 'name:en'], // 指定言語がない場合は英語
                    ['get', 'name']     // それもない場合はデフォルト
                ]);
            }
        });

        // UIボタンの状態更新
        document.querySelectorAll('.btn-lang').forEach(btn => {
            btn.classList.toggle('active', btn.innerText.includes(langCode === 'ja' ? '日本語' : langCode === 'en' ? 'English' : '中国語'));
        });
    }

    setupMapLayers() {
        this.map.addSource('circles-source', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
        this.map.addLayer({
            id: 'layer-fill', type: 'fill', source: 'circles-source',
            paint: { 'fill-color': ['match', ['get', 'type'], 'include', '#1d9bf0', '#e0245e'], 'fill-opacity': 0.3 }
        });
    }

    bindEvents() {
        this.map.on('click', (e) => {
            if (!this.state.mode) return;
            this.addCircle(e.lngLat.lat, e.lngLat.lng, 50, this.state.mode);
            this.state.mode = null;
            this.map.getCanvas().style.cursor = '';
        });

        document.getElementById('btn-add-inc').onclick = () => { this.state.mode = 'include'; this.map.getCanvas().style.cursor = 'crosshair'; };
        document.getElementById('btn-add-exc').onclick = () => { this.state.mode = 'exclude'; this.map.getCanvas().style.cursor = 'crosshair'; };

        document.getElementById('addr-search').onkeydown = async (e) => {
            if (e.key === 'Enter') {
                const res = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(e.target.value)}&limit=1`);
                const data = await res.json();
                if (data.features.length > 0) {
                    const [lng, lat] = data.features[0].geometry.coordinates;
                    this.map.flyTo({ center: [lng, lat], zoom: 10 });
                }
            }
        };
    }

    addCircle(lat, lng, radius, type) {
        if (this.state.circles.filter(c => c.type === type).length >= 4) return alert("最大4つまでです");
        this.history.push(JSON.stringify(this.state.circles));
        this.state.circles.push({ id: Date.now().toString(), lat, lng, radius, type });
        this.update();
    }

    updateCircle(id, radius) {
        this.state.circles = this.state.circles.map(c => c.id === id ? { ...c, radius } : c);
        this.update();
    }

    removeCircle(id) {
        this.history.push(JSON.stringify(this.state.circles));
        this.state.circles = this.state.circles.filter(c => c.id !== id);
        this.update();
    }

    update() {
        // 地図更新
        const features = this.state.circles.map(c => {
            const circle = turf.circle([c.lng, c.lat], c.radius, { units: 'kilometers' });
            circle.properties = { type: c.type };
            return circle;
        });
        this.map.getSource('circles-source').setData({ type: 'FeatureCollection', features });

        // リスト表示更新
        const list = document.getElementById('circle-list');
        list.innerHTML = '';
        this.state.circles.forEach(c => {
            const div = document.createElement('div');
            div.className = `circle-item type-${c.type}`;
            div.innerHTML = `
                <div style="font-size:11px"><strong>${c.type === 'include' ? '追加' : '除外'}</strong> ${c.radius}km</div>
                <input type="range" min="1" max="500" value="${c.radius}" oninput="app.updateCircle('${c.id}', parseInt(this.value))">
                <button onclick="app.removeCircle('${c.id}')" style="background:none; border:none; color:#666; cursor:pointer;">×</button>
            `;
            list.appendChild(div);
        });

        // クエリ更新
        const query = this.state.circles.map(c => `${c.type === 'include' ? '' : '-'}geocode:${c.lat.toFixed(5)},${c.lng.toFixed(5)},${c.radius}km`).join(' ');
        document.getElementById('query-text').innerText = query || '円を配置してください';
        
        // 状態保存
        localStorage.setItem('geo_state_pro', JSON.stringify(this.state.circles));
        document.getElementById('btn-add-inc').innerText = `+ 追加 (${this.state.circles.filter(c => c.type === 'include').length}/4)`;
        document.getElementById('btn-add-exc').innerText = `- 除外 (${this.state.circles.filter(c => c.type === 'exclude').length}/4)`;
    }

    undo() {
        if (this.history.length === 0) return;
        this.state.circles = JSON.parse(this.history.pop());
        this.update();
    }

    copyQuery() {
        navigator.clipboard.writeText(document.getElementById('query-text').innerText);
        alert("コピーしました");
    }

    load() {
        const saved = localStorage.getItem('geo_state_pro');
        if (saved) { this.state.circles = JSON.parse(saved); this.update(); }
    }
}

const app = new GeoTargeter();
</script>

</body>
</html>
